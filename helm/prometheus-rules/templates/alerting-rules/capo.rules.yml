{{- if or (eq .Values.managementCluster.provider.kind "openstack") }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels: {{- include "labels.common" . | nindent 4}}
  name: capo.rules
  namespace: {{.Values.namespace}}
spec:
  groups:
    - name: capo
      rules:
        - alert: OpenStackMachineUnexpectedInstanceState
          expr: capi_openstackmachine_status_instance_state{state!="ACTIVE"} > 0
          for: 1h
          labels:
            area: kaas
            cancel_if_outside_working_hours: {{include "workingHoursOnly" .}}
            severity: notify
            team: {{include "providerTeam" .}}
            topic: managementcluster
          annotations:
            description: |-
              {{`OpenStackMachine {{$labels.exported_namespace}}/{{$labels.name}} instance state is {{$labels.state}}.`}}

        - alert: OpenStackMachineFailure
          expr: capi_openstackmachine_status_failure{reason!=""}
          for: 30m
          labels:
            area: kaas
            cancel_if_outside_working_hours: {{include "workingHoursOnly" .}}
            severity: notify
            team: {{include "providerTeam" .}}
            topic: managementcluster
          annotations:
            description: |-
              {{`OpenStackMachine {{$labels.exported_namespace}}/{{$labels.name}} failure reason is {{$labels.reason}}.`}}
            opsrecipe: remove-errors-from-capi-capo-crs/

        - alert: OpenStackClusterFailure
          expr: capi_openstackcluster_status_failure{reason!=""}
          for: 30m
          labels:
            area: kaas
            cancel_if_outside_working_hours: {{include "workingHoursOnly" .}}
            severity: notify
            team: {{include "providerTeam" .}}
            topic: managementcluster
          annotations:
            description: |-
              {{`OpenStackCluster {{$labels.exported_namespace}}/{{$labels.name}} failure reason is {{$labels.reason}}.`}}
            opsrecipe: remove-errors-from-capi-capo-crs/
{{- end }}