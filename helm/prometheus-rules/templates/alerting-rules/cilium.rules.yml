apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    {{- include "labels.common" . | nindent 4 }}
  name: cilium.rules
  namespace: {{ .Values.namespace  }}
spec:
  groups:
  - name: cilium
    rules:
    - alert: CiliumBPFMapAlmostFull
      annotations:
        description: '{{`Cilium BPF map is about to fill up.`}}'
        opsrecipe: cilium-bpf-map/
      expr: avg(cilium_bpf_map_pressure) by (cluster_id, map_name) * 100 > 80
      for: 15m
      labels:
        area: managedservices
        cancel_if_outside_working_hours: "true"
        severity: page
        team: cabbage
        topic: cilium
    - alert: CiliumBPFMapFull
      annotations:
        description: '{{`Cilium BPF map is about filled up.`}}'
        opsrecipe: cilium-bpf-map/
      expr: avg(cilium_bpf_map_pressure) by (cluster_id, map_name) * 100 > 95
      for: 15m
      labels:
        area: managedservices
        severity: page
        team: cabbage
        topic: cilium
    - alert: CiliumFailedNetworkPolicy
      annotations:
        description: '{{`Too many Cilium Network Policy errors.`}}'
        opsrecipe: unsupported-cilium-network-policy/
      # cilium_policy_change_total - for cilium >=1.15
      # cilium_policy_import_errors_total - for cilium <1.15
      expr: (sum_over_time(cilium_policy_change_total{outcome=~"fail.*"}[5m]) OR sum_over_time(cilium_policy_import_errors_total[5m]) OR vector(0)) > 10
      for: 30m
      labels:
        area: managedservices
        cancel_if_outside_working_hours: {{ include "workingHoursOnly" . }}
        severity: page
        team: cabbage
        topic: cilium

