apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    {{- include "labels.common" . | nindent 4 }}
  name: fluxcd.rules
  namespace: {{ .Values.namespace  }}
spec:
  groups:
  - name: fluxcd
    rules:
    - alert: DeploymentNotSatisfiedFlux
      annotations:
        description: '{{`Flux deployment {{ $labels.namespace}}/{{ $labels.deployment }} is not satisfied.`}}'
        opsrecipe: deployment-not-satisfied/
      expr: kube_deployment_status_replicas_unavailable{cluster_type="management_cluster", namespace=~"flux-.*"} > 0
      for: 30m
      labels:
        area: managedservices
        cancel_if_cluster_status_creating: "true"
        cancel_if_cluster_status_deleting: "true"
        cancel_if_cluster_status_updating: "true"
        severity: page
        team: honeybadger
        topic: managementcluster
    - alert: FluxHelmReleaseFailed
      annotations:
        description: |-
          {{`Flux HelmRelease {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is stuck in Failed state.`}}
        opsrecipe: fluxcd-failing-helmrelease/
      expr: gotk_reconcile_condition{type="Ready", status="False", kind="HelmRelease", cluster_type="management_cluster"} > 0
      for: 10m
      labels:
        area: kaas
        severity: page
        team: honeybadger
        topic: releng
    - alert: FluxWorkloadClusterHelmReleaseFailed
      annotations:
        description: |-
          {{`Flux HelmRelease {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is stuck in Failed state.`}}
        opsrecipe: fluxcd-failing-helmrelease/
      expr: gotk_reconcile_condition{type="Ready", status="False", kind="HelmRelease", cluster_type="workload_cluster"} > 0
      for: 2h
      labels:
        area: kaas
        severity: page
        cancel_if_outside_working_hours: "true"
        team: honeybadger
        topic: releng
    - alert: FluxKustomizationFailed
      annotations:
        description: |-
          {{`Flux Kustomization {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is stuck in Failed state.`}}
        opsrecipe: fluxcd-failing-kustomization/
      expr: gotk_reconcile_condition{type="Ready", status="False", kind="Kustomization", cluster_type="management_cluster"} > 0
      for: 10m
      labels:
        area: kaas
        severity: page
        team: honeybadger
        topic: releng
    - alert: FluxWorkloadClusterKustomizationFailed
      annotations:
        description: |-
          {{`Flux Kustomization {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is stuck in Failed state.`}}
        opsrecipe: fluxcd-failing-kustomization/
      expr: gotk_reconcile_condition{type="Ready", status="False", kind="Kustomization", cluster_type="workload_cluster"} > 0
      for: 2h
      labels:
        area: kaas
        severity: page
        cancel_if_outside_working_hours: "true"
        team: honeybadger
        topic: releng
    - alert: FluxSourceFailed
      annotations:
        description: |-
          {{`Flux {{ $labels.kind }} {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is stuck in Failed state.`}}
        opsrecipe: fluxcd-failing-source/
      expr: gotk_reconcile_condition{type="Ready", status="False", kind=~"GitRepository|HelmRepository|Bucket", cluster_type="management_cluster"} > 0
      for: 2h
      labels:
        area: kaas
        severity: page
        team: honeybadger
        topic: releng
    - alert: FluxWorkloadClusterSourceFailed
      annotations:
        description: |-
          {{`Flux {{ $labels.kind }} {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is stuck in Failed state.`}}
        opsrecipe: fluxcd-failing-source/
      expr: gotk_reconcile_condition{type="Ready", status="False", kind=~"GitRepository|HelmRepository|Bucket", cluster_type="workload_cluster"} > 0
      for: 2h
      labels:
        area: kaas
        severity: page
        cancel_if_outside_working_hours: "true"
        team: honeybadger
        topic: releng
    - alert: FluxReconciliationTakingTooLong
      annotations:
        description: |-
          {{`Flux controller {{ $labels.controller }} on {{ $labels.installation }}/{{ $labels.cluster_id }} is reconciling very slowly.`}}
        opsrecipe: fluxcd-slow-reconciliation/
      expr: |
        (sum(rate(controller_runtime_reconcile_time_seconds_sum{app=~".*flux.*"}[5m])) by (installation, cluster_id, controller) /
        sum(rate(controller_runtime_reconcile_time_seconds_count{app=~".*flux.*"}[5m])) by (installation, cluster_id, controller)) > 60
      for: 10m
      labels:
        area: kaas
        cancel_if_outside_working_hours: "true"
        severity: page
        team: honeybadger
        topic: releng
    - alert: FluxSuspendedForTooLong
      annotations:
        description: |-
          {{`Flux {{ $labels.kind }} {{ $labels.name }} in ns {{ $labels.namespace }} on {{ $labels.installation }} has been suspended for 24h.`}}
      expr: gotk_suspend_status{namespace="flux-giantswarm"} > 0
      for: 24h
      labels:
        area: kaas
        cancel_if_outside_working_hours: "true"
        severity: page
        team: honeybadger
        topic: releng
