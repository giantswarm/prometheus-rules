apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    {{- include "labels.common" . | nindent 4 }}
  name: monitoring.rules
  namespace: {{ .Values.namespace  }}
spec:
  groups:
    ## TODO(quentin) add tests for the monitoring agent alerts
    ## TODO(quentin) add opsrecipe for the monitoring agent alerts
    ## TODO(quentin) add dashboard annotation for the monitoring agent alerts
    ## TODO(quentin) replace PrometheusAgentShardsMissing for alloy-metrics
    ## TODO(quentin) add component specific errors to replace the ones in the prometheus.rules.yml
    - name: monitoring-agent
      rules:
          ## This alert pages if the monitoring-agent fails to send samples to its remote write endpoint.
        - alert: MonitoringAgentFailing
          annotations:
            description: '{{`Monitoring agent fails to send its data via remote write.`}}'
            summary: Monitoring agent fails to send samples to its configured remote write endpoint.
            opsrecipe: monitoring-agent/
          expr: |-
            (
              label_replace(
                capi_cluster_status_condition{type="ControlPlaneReady", status="True"},
                "cluster_id",
                "$1",
                "name",
                "(.*)"
              ) == 1
            ) unless on (cluster_id) (
              count(up{job="alloy-metrics"} > 0) by (cluster_id)
            )
          for: 20m
          labels:
            area: platform
            severity: page
            team: atlas
            topic: observability
            inhibit_monitoring_agent_down: "true"
            cancel_if_cluster_is_not_running_monitoring_agent: "true"
            cancel_if_cluster_status_creating: "true"
            cancel_if_cluster_status_deleting: "true"
            cancel_if_cluster_has_no_workers: "true"
        ## Same as MonitoringAgentFailing, but triggers inhibition earlier and does not page.
        - alert: InhibitionMonitoringAgentFailing
          annotations:
            description: '{{`Monitoring agent fails to send its data via remote write.`}}'
            summary: Monitoring agent fails to send samples to its configured remote write endpoint.
            opsrecipe: monitoring-agent/
          expr: |-
            (
              label_replace(
                capi_cluster_status_condition{type="ControlPlaneReady", status="True"},
                "cluster_id",
                "$1",
                "name",
                "(.*)"
              ) == 1
            ) unless on (cluster_id) (
              count(up{job="prometheus-agent"} > 0) by (cluster_id)
            )
          for: 2m
          labels:
            area: platform
            severity: none
            team: atlas
            topic: observability
            inhibit_monitoring_agent_down: "true"
            cancel_if_cluster_is_not_running_monitoring_agent: "true"
            cancel_if_cluster_status_creating: "true"
            cancel_if_cluster_status_deleting: "true"

