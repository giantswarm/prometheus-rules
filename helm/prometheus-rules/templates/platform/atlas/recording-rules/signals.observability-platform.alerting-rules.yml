apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    {{- include "labels.common" . | nindent 4}}
  name: signals.observability-platform.rules
  namespace: {{ .Values.namespace }}
spec:
  groups:
    - name: signals.observability-platform
      rules:
        # Mimir rules with extracted cluster_id and enriched labels
        - record: giantswarm:observability:signals:mimir_rules
          expr: |
            label_replace(
              label_replace(
                label_replace(
                  label_replace(
                    label_replace(
                      sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, user, rule_group) (
                        cortex_prometheus_rule_group_rules{cluster_type="management_cluster", rule_group=~".+"}
                      ),
                      "cluster_id", "$1", "rule_group", "/data/[^/]+/([^%/]+)%2F[^%/]+%2F[^%/]+%2F[^;]+;.*"
                    ),
                    "source_system", "mimir", "", ""
                  ),
                  "creation_mode", "clickops", "", ""
                ),
                "creation_mode", "gitops", "rule_group", "/data/[^/]+/[^%/]+%2F[^%/]+%2F[^%/]+%2F[^;]+;.*"
              ),
              "tenant", "$1", "user", "(.*)"
            )

        # Loki rules with extracted cluster_id and enriched labels
        - record: giantswarm:observability:signals:loki_rules
          expr: |
            label_replace(
              label_replace(
                label_replace(
                  label_replace(
                    label_replace(
                      sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, user, rule_group) (
                        loki_prometheus_rule_group_rules{cluster_type="management_cluster", rule_group=~".+"}
                      ),
                      "cluster_id", "$2", "rule_group", "/var/loki/rules-temp/[^/]+/([^-]+-[^-]+-([^-]+)-[^;]+);.*"
                    ),
                    "source_system", "loki", "", ""
                  ),
                  "creation_mode", "clickops", "", ""
                ),
                "creation_mode", "gitops", "rule_group", "/var/loki/rules-temp/[^/]+/[^-]+-[^-]+-[^-]+-[^;]+;.*"
              ),
              "tenant", "$1", "user", "(.*)"
            )

        # Grafana Cloud Exporter rules with enriched labels
        - record: giantswarm:observability:signals:grafana_cloud_exporter_rules
          expr: |
            label_replace(
              label_replace(
                label_replace(
                  sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, rule_group) (
                    prometheus_rule_group_rules{cluster_type="management_cluster", rule_group=~".+"}
                  ),
                  "source_system", "prometheus", "", ""
                ),
                "creation_mode", "gitops", "rule_group", "/etc/prometheus/rules/prometheus-mimir-to-grafana-cloud-rulefiles-0/[^-]+-[^-]+-[^.]+\\.yaml;.*"
              ),
              "tenant", "giantswarm", "", ""
            )

        # Grafana rules with enriched labels
        - record: giantswarm:observability:signals:grafana_alerting_rules
          expr: |
            label_replace(
              label_replace(
                label_replace(
                  sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, rule_group) (
                    grafana_alerting_rule_group_rules{cluster_type="management_cluster", rule_group=~".+"}
                  ),
                  "source_system", "grafana", "", ""
                ),
                "creation_mode", "clickops", "", ""
              ),
              "tenant", "unknown", "", ""
            )

        # === FIRED ALERTS PER TENANT ===
        
        # Base fired alerts from Mimir Alertmanager with tenant enrichment
        - record: giantswarm:observability:signals:fired_alerts_mimir_base
          expr: |
            # Enrich ALERTS with tenant info by joining with mimir rules metric
            label_join(
              sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, alertname, severity, tenant, source_system) (
                ALERTS{alertstate="firing"} 
                * on(cluster_id, alertname) group_left(tenant, source_system)
                label_replace(giantswarm:observability:signals:mimir_rules, "source_system", "mimir", "", "")
              ),
              "alert_source", ",", "source_system"
            )

        # Fired alerts from other sources (without tenant info for now)  
        - record: giantswarm:observability:signals:fired_alerts_other_base
          expr: |
            label_replace(
              sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, alertname, severity) (
                ALERTS{alertstate="firing"}
                unless on(cluster_id, alertname) 
                giantswarm:observability:signals:mimir_rules
              ),
              "tenant", "unknown", "", ""
            )
            
        # Combined fired alerts per tenant metric
        - record: giantswarm:observability:signals:fired_alerts_per_tenant
          expr: |
            sum by (cluster_id, cluster_type, customer, installation, pipeline, provider, region, tenant, severity) (
              giantswarm:observability:signals:fired_alerts_mimir_base
              or
              giantswarm:observability:signals:fired_alerts_other_base
            )
