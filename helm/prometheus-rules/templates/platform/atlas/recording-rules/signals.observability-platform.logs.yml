apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    {{- include "labels.common" . | nindent 4}}
  name: signals.observability-platform.logs.rules
  namespace: {{ .Values.namespace }}
spec:
  groups:
    - name: signals.observability-platform.logs
      rules:
        - record: giantswarm:observability:grafana:unique_users:30d
          annotations:
            description: "The number of unique Grafana users over the last 30 days"
          expr: |
            count(
                count(
                    count_over_time(
                        {container="grafana"}
                            | logfmt
                            | handler="/api/live/ws"
                            |~ `uname=.*@.*`
                            !~ `uname=.*@giantswarm\.io`
                            | line_format "{{.uname}}"[30d]
                    )
                ) by (uname, cluster_id, cluster_type, customer, installation, pipeline, provider, region)
          ) by (uname, cluster_id, cluster_type, customer, installation, pipeline, provider, region)
