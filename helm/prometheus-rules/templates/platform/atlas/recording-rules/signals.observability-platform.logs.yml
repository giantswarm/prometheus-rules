apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    {{- include "labels.common" . | nindent 4}}
  name: signals.observability-platform.logs.rules
  namespace: {{ .Values.namespace }}
spec:
  groups:
    - name: signals.observability-platform.logs
      rules:
        - record: giantswarm:observability:grafana:unique_users:hourly
          expr: |
            count by (uname, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
                count by (uname, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
                    count_over_time(
                        {container="grafana", cluster_id="{{ .Values.managementCluster.name }}"}
                            | logfmt
                            | handler="/api/live/ws"
                            |~ `uname=.*@.*`
                            !~ `uname=.*@giantswarm\.io`
                            | line_format "{{`{{.uname}}`}}"
                        [1h]
                    )
                ) 
            )
        - record: giantswarm:observability:grafana:dashboard_views:total
          expr: |
            sum by (dashboard_id, dashboard_name, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
              count_over_time (
                {cluster_id="{{ .Values.managementCluster.name }}", container="proxy", namespace="monitoring"}
                |~ "GET /d/|GET /api/dashboards/uid/"
                | pattern `<ip> - - [<time>] "<method> <uri> <protocol>" <status> <size> "<referrer>" "<agent>" "<forwarded_for>"`
                | method = `GET`
                | uri =~ "(/d/|/api/dashboards/uid/).+"
                | line_format "{{.uri}} ||| {{.referrer}}"
                | regexp `(?i)\/d\/(?P<dashboard_id>[^/]+)\/(?P<dashboard_name>[^/?\s]+)`
                [1m]
              )
            )
        # Track total Grafana query requests (POST to query endpoints) to measure query activity
        - record: giantswarm:observability:grafana:executed_queries:total
          expr: |
            (
              sum by (ds_type, uname, statusCode, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
                count_over_time(
                  (
                    {cluster_id="{{ .Values.managementCluster.name }}", container="grafana"}
                    |= "logger=tsdb.loki"
                    |~ "statusCode=[0-9]+"
                    | regexp `pluginId=(?P<ds_type>[^ ]+)`
                    | regexp `uname=(?P<uname>[^ ]+)`
                    | regexp `statusCode=(?P<statusCode>[0-9]+)`
                  )[1m]
                )
              )
            )
            or
            (
              sum by (ds_type, uname, statusCode, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
                count_over_time(
                  (
                    {cluster_id="{{ .Values.managementCluster.name }}", container="grafana"}
                    |= "path=/api/ds/query"
                    != "logger=tsdb.loki"
                    !~ "/a/grafana-(metricsdrilldown|exploretraces|lokiexplore)-app|/explore "
                    |~ "status=[0-9]+"
                    | regexp `uname=(?P<uname>[^ ]+)`
                    | regexp `status=(?P<statusCode>[0-9]+)`
                    | regexp `type%22%3A%22(?P<ds_type>[^%]+)`
                  )[1m]
                )
              )
            )

        # Track explore page visits (GET /explore or requests with explore referrer)
        - record: giantswarm:observability:grafana:explore_visits:total 
          expr: |
            sum by (status, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
              count_over_time(
                {cluster_id="{{ .Values.managementCluster.name }}", container="proxy", namespace="monitoring"}
                | pattern `<ip> - - [<time>] "<method> <uri> <protocol>" <status> <size> "<referrer>" "<agent>" "<forwarded_for>"`
                | (method = `GET` and uri =~ `/explore`) or referrer =~ `.*/explore.*`
                | uri !~ `.*\.(js|css|svg|png|woff2)`
                [1m]
              )
            )
        # Track drilldown visits (metricsdrilldown, exploretraces, lokiexplore)
        - record: giantswarm:observability:grafana:drilldown_visits:total
          expr: |
            sum by (status, app_name, action, cluster_id, cluster_type, customer, installation, pipeline, provider, region) (
              count_over_time(
                {cluster_id="{{ .Values.managementCluster.name }}", container="grafana", namespace="monitoring"}
                # Only logs where referer contains a Grafana app
                |~ `referer="https://[^/]+/a/grafana-(metricsdrilldown|exploretraces|lokiexplore)-app/.*"`
                # Extract app_name and action from referer
                | regexp `referer="https://[^/]+/a/grafana-(?P<app_name>[^/]+)-app/(?P<action>[^?"]+)`
                # Extract numeric status separately
                | regexp `status=(?P<status>[0-9]+)`
                [1m]
              )
            )
