---
rule_files:
  - cilium.rules.yml

tests:
  - interval: 1m
    input_series:
      # For the first 60min: test with 1 pod: none, up, down
      - series: 'cilium_bpf_map_pressure{map_name="policy_00001"}'
        values: "_x20 0.2+0x20 0.9+0x20"
    alert_rule_test:
      - alertname:  CiliumBPFMapAlmostFull
        eval_time: 10m
      - alertname:  CiliumBPFMapAlmostFull
        eval_time: 30m
      - alertname:  CiliumBPFMapAlmostFull
        eval_time: 50m
        exp_alerts:
          - exp_labels:
              area: kaas
              severity: page
              team: phoenix
              topic: cilium
              cancel_if_outside_working_hours: "true"
            exp_annotations:
              description: "Cilium BPF map is about to fill up."

tests:
  - interval: 1m
    input_series:
      # For the first 60min: test with 1 pod: none, up, down
      - series: 'cilium_bpf_map_pressure{map_name="policy_00001"}'
        values: "_x20 0.2+0x20 0.9+0x20 0.98+0x20"
    alert_rule_test:
      - alertname:  CiliumBPFMapFull
        eval_time: 10m
      - alertname:  CiliumBPFMapFull
        eval_time: 30m
      - alertname:  CiliumBPFMapFull
        eval_time: 70m
        exp_alerts:
          - exp_labels:
              area: kaas
              severity: page
              team: phoenix
              topic: cilium
              cancel_if_outside_working_hours: "true"
            exp_annotations:
              description: "Cilium BPF map is about filled up."
