---
rule_files:
  - prometheus.rules.yml

evaluation_interval: 1h

tests:
  - interval: 1h
    input_series:
      - series: 'up{app="kubernetes",installation="gauss",cluster_id="gauss",job="gauss-prometheus/kubernetes-apiserver-gauss/0"}'
        values: "1+0x240"
      - series: 'up{app="kube-controller-manager",installation="gauss",cluster_id="gauss",job="gauss-prometheus/kubernetes-controller-manager-gauss/0"}'
        values: "1+0x120 0+0x120"
      - series: 'up{app="kube-scheduler",installation="gauss",cluster_id="gauss",job="gauss-prometheus/kubernetes-scheduler-gauss/0"}'
        values: "1+0x240"
      - series: 'up{app="kubelet",installation="gauss",cluster_id="gauss",job="gauss-prometheus/kubernetes-kubelet-gauss/0"}'
        values: "1+0x240"
      - series: 'up{app="node-exporter",installation="gauss",cluster_id="gauss",job="gauss-prometheus/node-exporter-gauss/0"}'
        values: "1+0x240"
      - series: 'up{app="kube-state-metrics",installation="gauss",cluster_id="gauss",job="gauss-prometheus/kube-state-metrics-gauss/0"}'
        values: "1+0x240"
    alert_rule_test:
      - alertname: PrometheusJobScrapingFailure
        eval_time: 3h
      - alertname: PrometheusJobScrapingFailure
        eval_time: 1d
      - alertname: PrometheusJobScrapingFailure
        eval_time: 4d
      - alertname: PrometheusJobScrapingFailure
        eval_time: 9d
        exp_alerts:
          - exp_labels:
              area: empowerment
              severity: page
              team: atlas
              topic: observability
              app: "kube-controller-manager"
              cluster_id: "gauss"
              installation: "gauss"
              job: "gauss-prometheus/kubernetes-controller-manager-gauss/0"
              cancel_if_outside_working_hours: "true"
              cancel_if_cluster_status_creating: true
              cancel_if_cluster_status_deleting: true
            exp_annotations:
              opsrecipe: "prometheus-job-scraping-failure/"
              summary: "Prometheus fails to scrape all targets in a job."
              description: "Prometheus gauss/gauss has failed to scrape all targets in gauss-prometheus/kubernetes-controller-manager-gauss/0 job."
