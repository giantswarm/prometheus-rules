groups:
  - name: capi
    rules:
      - alert: MachineUnhealthyPhase
        annotations:
          description: |-
            Machine {{ $labels.exported_namespace}}/{{ $labels.name }} stuck in phase {{ $labels.phase }} for more than 30 minutes.
        expr: capi_machine_status_phase{phase!="Running"} > 0
        for: 30m
        labels:
          area: kaas
          cancel_if_outside_working_hours: "true"
          severity: notify
          team: rocket
          topic: managementcluster
      - alert: MachineDeploymentReplicasMismatch
        expr: capi_machinedeployment_spec_replicas{} != capi_machinedeployment_status_replicas_available{}
        for: 1h
        labels:
          area: kaas
          cancel_if_outside_working_hours: "true"
          severity: notify
          team: rocket
          topic: managementcluster
        annotations:
          description: |-
            The clusters {{$labels.cluster_name}} machinedeployment {{$labels.exported_namespace}}/{{$labels.machinedeployment}} does not match the expected number of replicas for longer than 1h.
      - alert: KubeadmControlPlaneReplicasMismatch
        expr: capi_kubeadmcontrolplane_spec_replicas != capi_kubeadmcontrolplane_status_replicas_ready
        # 90min at max 3 replicas results in maximum of 30 minutes per control-plane machine.
        for: 90m
        labels:
          area: kaas
          cancel_if_outside_working_hours: "true"
          severity: notify
          team: rocket
          topic: managementcluster
        annotations:
          description: |-
            The clusters {{$labels.cluster_name}} kubeadmcontrolplane {{$labels.exported_namespace}}/{{$labels.name}} does not match the expected number of replicas for longer than 90 minutes.
      - alert: ClusterUnhealthyPhase
        expr: capi_cluster_status_phase{phase!="Provisioned"} > 0
        for: 1h
        labels:
          area: kaas
          cancel_if_outside_working_hours: "true"
          severity: notify
          team: rocket
          topic: managementcluster
        annotations:
          description: |-
            Cluster {{$labels.exported_namespace}}/{{$labels.cluster_name}} is in a non healthy phase.
